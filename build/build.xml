<project name="golibs" default="all">

    <property environment="env"/>
    <property name="env.PONEY_HOME" value="//file1/masa/common/dev/delivery/internal/poney/current"/>
    <import file="${env.PONEY_HOME}/poney.xml"/>

    <target name="update">
        <update name="golang" version="1.4"/>
        <update name="protobuf" version="2.3.0"/>
    </target>

    <macrodef name="go_vet">
        <attribute name="module"/>
        <element name="elements" implicit="true" optional="true"/>
        <sequential>
            <go_exec gopath="${root.dir}">
                <arg value="tool"/>
                <arg value="vet"/>
                <elements/>
                <arg value="${root.dir}/@{module}"/>
            </go_exec>
        </sequential>
    </macrodef>

    <target name="build">
        <go_build/>
        <go_vet module="src">
            <!-- There are too many Print() behaving like Printf. Not easy
                 to fix upstream since it means changing the API.
            -->
            <arg value="-printf=false"/>
            <!-- go-spew does weird things in tests -->
            <arg value="-unsafeptr=false"/>
        </go_vet>
    </target>

    <target name="test">
        <go cmd="test"/>
    </target>

    <target name="package">
        <go_package/>
        <safe-move file="${out.dir}/bin_${platform}.zip">
            <zip destfile="@{file}" duplicate="fail">
                <mappedresources>
                    <fileset dir="${root.dir}/bin" includes="proto*.exe"/>
                    <flattenmapper/>
                </mappedresources>
            </zip>
        </safe-move>
    </target>

    <target name="all" depends="update,build,test,package"/>

</project>
